{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Maintenance Windows for Updating SSM Agent",
    "Parameters": {
        "SchedExpWin": {
            "Description": "schedule to run the maintenance window",
            "Default": "cron(0 10 * ? * * *)",
            "Type": "String",
            "ConstraintDescription": "must specify a valid cron or rate expression"
        },
        "SchedExpLinux": {
            "Description": "schedule to run the maintenance window",
            "Default": "cron(0 50 14 ? * * *)",
            "Type": "String",
            "ConstraintDescription": "must specify a valid cron or rate expression"
        },
        "SchedExpAMZLinux": {
            "Description": "schedule to run the maintenance window",
            "Default": "cron(0 50 14 ? * * *)",
            "Type": "String",
            "ConstraintDescription": "must specify a valid cron or rate expression"
        },
        "Duration": {
            "Description": "max duration of the maintenance window in hours",
            "Default": 3,
            "Type": "Number"
        },
        "Cutoff": {
            "Description": "hours before window closure to cut off new activity",
            "Default": 1,
            "Type": "Number",
            "ConstraintDescription": "must be < (Duration - 1)"
        },
        "AllowUnregisteredTargets": {
            "Description": "allow or disallow any individual managed instance",
            "Default": true,
            "Type": "String",
            "AllowedValues": [
                true,
                false
            ]
        },
              "GatherInventorySchedule": {
            "Description": "How frequently you want to execute the lambda function, Refer here for help https://docs.aws.amazon.com/eventbridge/latest/userguide/scheduled-events.html",
            "Default": "rate(12 hours)",
            "Type": "String"
        }
    },
    "Resources": {
        "LoggingBucket": {
            "Type": "AWS::S3::Bucket"
        },
        "AutomationServiceRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ssm.amazonaws.com",
                                    "ec2.amazonaws.com"
                                ]
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonSSMAutomationRole"
                ],
                "Path": "/",
                "RoleName": "AutomationServiceRole"
            }
        },
        "CreateMaintenanceWindowWIN": {
            "Type": "AWS::SSM::MaintenanceWindow",
            "Properties": {
                "Description": "Maintenance window for Windows Servers",
                "AllowUnassociatedTargets": {
                    "Ref": "AllowUnregisteredTargets"
                },
                "Cutoff": {
                    "Ref": "Cutoff"
                },
                "Schedule": {
                    "Ref": "SchedExpWin"
                },
                "Duration": {
                    "Ref": "Duration"
                },
                "Name": "SRV_SATURDAY_4AM-6AM_Maintenance_Window_Windows"
            }
        },
        "CreateTaskTargetsWin": {
            "Type": "AWS::SSM::MaintenanceWindowTarget",
            "Properties": {
                "Description": "Task Target for Windows",
                "WindowId": {
                    "Ref": "CreateMaintenanceWindowWIN"
                },
                "ResourceType": "INSTANCE",
                "Targets": [
                    {
                        "Key": "tag:Patch Group",
                        "Values": [
                            "SRV_SATURDAY_4AM-6AM"
                        ]
                    }
                ],
                "Name": "TaskTarget-Win"
            }
        },
        "CreatePatchBaselineWin": {
            "Type": "AWS::SSM::PatchBaseline",
            "Properties": {
                "Name": "WindowsApprovedPatches",
                "Description": "Baseline containing all updates approved for Windows instances",
                "OperatingSystem": "WINDOWS",
                "PatchGroups": [
                    "SRV_SATURDAY_4AM-6AM"
                ],
                "ApprovalRules": {
                    "PatchRules": [
                        {
                            "PatchFilterGroup": {
                                "PatchFilters": [
                                    {
                                        "Values": [
                                            "SecurityUpdates"
                                        ],
                                        "Key": "CLASSIFICATION"
                                    },
                                    {
                                        "Values": [
                                            "Critical"
                                        ],
                                        "Key": "MSRC_SEVERITY"
                                    },
                                    {
                                        "Values": [
                                            "*"
                                        ],
                                        "Key": "PRODUCT"
                                    }
                                ]
                            },
                            "ApproveAfterDays": 7,
                            "ComplianceLevel": "CRITICAL"
                        },
                        {
                            "PatchFilterGroup": {
                                "PatchFilters": [
                                    {
                                        "Values": [
                                            "Critical"
                                        ],
                                        "Key": "MSRC_SEVERITY"
                                    },
                                    {
                                        "Values": [
                                            "SecurityUpdates"
                                        ],
                                        "Key": "CLASSIFICATION"
                                    },
                                    {
                                        "Values": [
                                            "APPLICATION"
                                        ],
                                        "Key": "PATCH_SET"
                                    },
                                    {
                                        "Values": [
                                            "*"
                                        ],
                                        "Key": "PRODUCT"
                                    },
                                    {
                                        "Values": [
                                            "*"
                                        ],
                                        "Key": "PRODUCT_FAMILY"
                                    }
                                ]
                            },
                            "ApproveAfterDays": 7,
                            "ComplianceLevel": "CRITICAL"
                        }
                    ]
                }
            }
        },
        "CreateTaskWin": {
            "Type": "AWS::SSM::MaintenanceWindowTask",
            "Properties": {
                "MaxErrors": 50,
                "Description": "Run UpdateSSMAgent command for all Patch Group values",
                "ServiceRoleArn": {
                    "Fn::GetAtt": [
                        "AutomationServiceRole",
                        "Arn"
                    ]
                },
                "Priority": 1,
                "MaxConcurrency": 50,
                "Targets": [
                    {
                        "Key": "WindowTargetIds",
                        "Values": [
                            {
                                "Ref": "CreateTaskTargetsWin"
                            }
                        ]
                    }
                ],
                "Name": "UpdateSSMAgent-task-Win",
                "TaskArn": "AWS-RunPatchBaseline",
                "TaskInvocationParameters": {
                    "MaintenanceWindowRunCommandParameters": {
                        "TimeoutSeconds": 600,
                        "Comment": "RunCommand task registered to UpdateSSMAgent-maintenance-window",
                        "OutputS3BucketName": {
                            "Ref": "LoggingBucket"
                        },
                        "OutputS3KeyPrefix": "Patch",
                        "Parameters": {
                            "Operation": [
                                "Scan",
                                "Install"
                            ]
                        },
                        "ServiceRoleArn": {
                            "Fn::GetAtt": [
                                "AutomationServiceRole",
                                "Arn"
                            ]
                        }
                    }
                },
                "WindowId": {
                    "Ref": "CreateMaintenanceWindowWIN"
                },
                "TaskType": "RUN_COMMAND"
            }
        },
        "CreateMaintenanceWindowLinux": {
            "Type": "AWS::SSM::MaintenanceWindow",
            "Properties": {
                "Description": "Maintenance window for Linux Servers",
                "AllowUnassociatedTargets": {
                    "Ref": "AllowUnregisteredTargets"
                },
                "Cutoff": {
                    "Ref": "Cutoff"
                },
                "Schedule": {
                    "Ref": "SchedExpLinux"
                },
                "Duration": {
                    "Ref": "Duration"
                },
                "Name": "LNX_SRV_SATURDAY_3AM-5AM_Maintenance_Window_Linux"
            }
        },
        "CreateTaskTargetsLinux": {
            "Type": "AWS::SSM::MaintenanceWindowTarget",
            "Properties": {
                "Description": "Task Target for Linux",
                "WindowId": {
                    "Ref": "CreateMaintenanceWindowLinux"
                },
                "ResourceType": "INSTANCE",
                "Targets": [
                    {
                        "Key": "tag:Patch Group",
                        "Values": [
                            "LNX_SRV_SATURDAY_3AM-5AM"
                        ]
                    }
                ],
                "Name": "TaskTarget-Linux"
            }
        },
        "CreatePatchBaselineLinux": {
            "Type": "AWS::SSM::PatchBaseline",
            "Properties": {
                "Name": "LinuxApprovedPatches",
                "Description": "Baseline containing all updates approved for Red Hat instances",
                "OperatingSystem": "REDHAT_ENTERPRISE_LINUX",
                "PatchGroups": [
                    "LNX_SRV_SATURDAY_3AM-5AM"
                ],
                "ApprovalRules": {
                    "PatchRules": [
                        {
                            "PatchFilterGroup": {
                                "PatchFilters": [
                                    {
                                        "Values": [
                                            "*"
                                        ],
                                        "Key": "CLASSIFICATION"
                                    },
                                    {
                                        "Values": [
                                            "Critical"
                                        ],
                                        "Key": "SEVERITY"
                                    },
                                    {
                                        "Values": [
                                            "*"
                                        ],
                                        "Key": "PRODUCT"
                                    }
                                ]
                            },
                            "ApproveAfterDays": 7,
                            "ComplianceLevel": "CRITICAL"
                        }
                    ]
                }
            }
        },
        "CreateTaskLinux": {
            "Type": "AWS::SSM::MaintenanceWindowTask",
            "Properties": {
                "MaxErrors": 50,
                "Description": "Run UpdateSSMAgent command for all Patch Group values",
                "ServiceRoleArn": {
                    "Fn::GetAtt": [
                        "AutomationServiceRole",
                        "Arn"
                    ]
                },
                "Priority": 1,
                "MaxConcurrency": 50,
                "Targets": [
                    {
                        "Key": "WindowTargetIds",
                        "Values": [
                            {
                                "Ref": "CreateTaskTargetsLinux"
                            }
                        ]
                    }
                ],
                "Name": "UpdateSSMAgent-task-Linux",
                "TaskArn": "AWS-RunPatchBaseline",
                "TaskInvocationParameters": {
                    "MaintenanceWindowRunCommandParameters": {
                        "TimeoutSeconds": 600,
                        "Comment": "RunCommand task registered to UpdateSSMAgent-maintenance-window",
                        "OutputS3BucketName": {
                            "Ref": "LoggingBucket"
                        },
                        "OutputS3KeyPrefix": "Patch",
                        "Parameters": {
                            "Operation": [
                                "Scan",
                                "Install"
                            ]
                        },
                        "ServiceRoleArn": {
                            "Fn::GetAtt": [
                                "AutomationServiceRole",
                                "Arn"
                            ]
                        }
                    }
                },
                "WindowId": {
                    "Ref": "CreateMaintenanceWindowLinux"
                },
                "TaskType": "RUN_COMMAND"
            }
        },
        "CreateMaintenanceWindowAMZNLNX": {
            "Type": "AWS::SSM::MaintenanceWindow",
            "Properties": {
                "Description": "Maintenance window for AMZNLNX Servers",
                "AllowUnassociatedTargets": {
                    "Ref": "AllowUnregisteredTargets"
                },
                "Cutoff": {
                    "Ref": "Cutoff"
                },
                "Schedule": {
                    "Ref": "SchedExpAMZLinux"
                },
                "Duration": {
                    "Ref": "Duration"
                },
                "Name": "AMZN_LNX_SRV_SATURDAY_3AM-5AM_Maintenance_Window"
            }
        },
        "CreateTaskTargetsAMZNLNX": {
            "Type": "AWS::SSM::MaintenanceWindowTarget",
            "Properties": {
                "Description": "Task Target for AMZNLNX",
                "WindowId": {
                    "Ref": "CreateMaintenanceWindowAMZNLNX"
                },
                "ResourceType": "INSTANCE",
                "Targets": [
                    {
                        "Key": "tag:Patch Group",
                        "Values": [
                            "AMZN_LNX_SRV_SATURDAY_3AM-5AM"
                        ]
                    }
                ],
                "Name": "TaskTarget-AMZNLNX"
            }
        },
        "CreatePatchBaselineAMZNLNX": {
            "Type": "AWS::SSM::PatchBaseline",
            "Properties": {
                "Name": "AmazonLinuxApprovedPatches",
                "Description": "Baseline containing all updates approved for Amazon Linux instances",
                "OperatingSystem": "AMAZON_LINUX",
                "PatchGroups": [
                    "AMZN_LNX_SRV_SATURDAY_3AM-5AM"
                ],
                "ApprovalRules": {
                    "PatchRules": [
                        {
                            "PatchFilterGroup": {
                                "PatchFilters": [
                                    {
                                        "Values": [
                                            "Security"
                                        ],
                                        "Key": "CLASSIFICATION"
                                    },
                                    {
                                        "Values": [
                                            "Critical"
                                        ],
                                        "Key": "SEVERITY"
                                    },
                                    {
                                        "Values": [
                                            "*"
                                        ],
                                        "Key": "PRODUCT"
                                    }
                                ]
                            },
                            "ApproveAfterDays": 7,
                            "ComplianceLevel": "CRITICAL"
                        }
                    ]
                }
            }
        },
        "CreateTaskAMZNLNX": {
            "Type": "AWS::SSM::MaintenanceWindowTask",
            "Properties": {
                "MaxErrors": 50,
                "Description": "Run UpdateSSMAgent command for all Patch Group values",
                "ServiceRoleArn": {
                    "Fn::GetAtt": [
                        "AutomationServiceRole",
                        "Arn"
                    ]
                },
                "Priority": 1,
                "MaxConcurrency": 50,
                "Targets": [
                    {
                        "Key": "WindowTargetIds",
                        "Values": [
                            {
                                "Ref": "CreateTaskTargetsAMZNLNX"
                            }
                        ]
                    }
                ],
                "Name": "UpdateSSMAgent-task-AMZNLNX",
                "TaskArn": "AWS-RunPatchBaseline",
                "TaskInvocationParameters": {
                    "MaintenanceWindowRunCommandParameters": {
                        "TimeoutSeconds": 600,
                        "Comment": "RunCommand task registered to UpdateSSMAgent-maintenance-window",
                        "OutputS3BucketName": {
                            "Ref": "LoggingBucket"
                        },
                        "OutputS3KeyPrefix": "Patch",
                        "Parameters": {
                            "Operation": [
                                "Scan",
                                "Install"
                            ]
                        },
                        "ServiceRoleArn": {
                            "Fn::GetAtt": [
                                "AutomationServiceRole",
                                "Arn"
                            ]
                        }
                    }
                },
                "WindowId": {
                    "Ref": "CreateMaintenanceWindowAMZNLNX"
                },
                "TaskType": "RUN_COMMAND"
            }
        },
        "GatherInventory": {
            "Type": "AWS::SSM::Association",
            "Properties": {
                "AssociationName": "GatherInventory",
                "Name": "AWS-GatherSoftwareInventory",
                "ScheduleExpression": {"Ref":  "GatherInventorySchedule"},
                "Targets": [
                    {
                        "Key": "InstanceIds",
                        "Values": [
                            "*"
                        ]
                    }
                ]
            }
        }
    },
    "Outputs": {
        "InventoryAssociationID": {
            "Description": "AssociationName",
            "Value": {
                "Ref": "GatherInventory"
            }
        }
    }
}