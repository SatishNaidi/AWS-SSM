{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Lambda Function to tag the EC2 Instances.",
    "Parameters": {
        "BucketForLambdaCode": {
            "Description": "Select the bucket name where the lambda function code resides",
            "Default": "mylambda-bucket",
            "Type": "String"
        },
        "EC2MasterLambdaCodeZip": {
            "Description": "Select the Key name in the bucket to consume the code, Code Should be uploaded to Bucket Prior",
            "Default": "master_ec2_patch_report.zip",
            "Type": "String"
        },
        "EC2SlaveLambdaCodeZip": {
            "Description": "Select the Key name in the bucket to consume the code, Code Should be uploaded to Bucket Prior",
            "Default": "slave_ec2_patch_report.zip",
            "Type": "String"
        },
        "CSVMergeLambdaCodeZip": {
            "Description": "Select the Key name in the bucket to consume the code, Code Should be uploaded to Bucket Prior",
            "Default": "merge_csv.zip",
            "Type": "String"
        },
        "PatchBaselineLambdaCodeZip": {
            "Description": "Select the Key name in the bucket to consume the code, Code Should be uploaded to Bucket Prior",
            "Default": "patch_baseline_report.zip",
            "Type": "String"
        },
        "EC2InstanceLambdaCodeZip": {
            "Description": "Select the Key name in the bucket to consume the code, Code Should be uploaded to Bucket Prior",
            "Default": "ec2_instance_report.zip",
            "Type": "String"
        },
        "LogsBucketName": {
            "Description": "List of Patch Baselines in comma separated values without spaces",
            "Default": "madhav-ssm-logs",
            "Type": "String"
        },
        "IAMArn": {
            "Description": "List of Patch Baselines in comma separated values without spaces",
            "Default": "arn:aws:iam::495830459543:role/FullAdmin",
            "Type": "String"
        }
    },
    "Resources": {
        "EC2MasterLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Code": {
                    "S3Bucket": {
                        "Ref": "BucketForLambdaCode"
                    },
                    "S3Key": {
                        "Ref": "EC2MasterLambdaCodeZip"
                    }
                },
                "Role": {
                    "Ref": "IAMArn"
                },
                "Environment": {
                    "Variables": {
                        "bucket_name": {
                            "Ref": "LogsBucketName"
                        },
                        "slave_function": "SSM-EC2PatchSlave"
                    }
                },
                "Timeout": 900,
                "Description": "EC2MasterLambda",
                "Handler": "master_ec2_patch_report.lambda_handler",
                "FunctionName": "SSM-EC2PatchMaster",
                "Runtime": "python3.7",
                "MemorySize": 128
            }
        },
        "EC2SlaveLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Code": {
                    "S3Bucket": {
                        "Ref": "BucketForLambdaCode"
                    },
                    "S3Key": {
                        "Ref": "EC2SlaveLambdaCodeZip"
                    }
                },
                "Role": {
                    "Ref": "IAMArn"
                },
                "Environment": {
                    "Variables": {
                        "bucket_name": {
                            "Ref": "LogsBucketName"
                        }
                    }
                },
                "Timeout": 900,
                "Description": "EC2SlaveLambda",
                "Handler": "slave_ec2_patch_report.lambda_handler",
                "FunctionName": "SSM-EC2PatchSlave",
                "Runtime": "python3.7",
                "MemorySize": 128
            }
        },
        "CSVMergeLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Code": {
                    "S3Bucket": {
                        "Ref": "BucketForLambdaCode"
                    },
                    "S3Key": {
                        "Ref": "CSVMergeLambdaCodeZip"
                    }
                },
                "Role": {
                    "Ref": "IAMArn"
                },
                "Environment": {
                    "Variables": {
                        "bucket_name": {
                            "Ref": "LogsBucketName"
                        }
                    }
                },
                "Timeout": 900,
                "Description": "EC2SlaveLambda",
                "Handler": "merge_csv.lambda_handler",
                "FunctionName": "SSM-CSVMerge",
                "Runtime": "python3.7",
                "MemorySize": 128
            }
        },
        "PatchBaselineLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Code": {
                    "S3Bucket": {
                        "Ref": "BucketForLambdaCode"
                    },
                    "S3Key": {
                        "Ref": "PatchBaselineLambdaCodeZip"
                    }
                },
                "Role": {
                    "Ref": "IAMArn"
                },
                "Environment": {
                    "Variables": {
                        "bucket_name": {
                            "Ref": "LogsBucketName"
                        }
                    }
                },
                "Timeout": 900,
                "Description": "EC2SlaveLambda",
                "Handler": "patch_baseline_report.lambda_handler",
                "FunctionName": "SSM-PatchBaseLineReport",
                "Runtime": "python3.7",
                "MemorySize": 128
            }
        },
        "EC2InstanceLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Code": {
                    "S3Bucket": {
                        "Ref": "BucketForLambdaCode"
                    },
                    "S3Key": {
                        "Ref": "EC2InstanceLambdaCodeZip"
                    }
                },
                "Role": {
                    "Ref": "IAMArn"
                },
                "Environment": {
                    "Variables": {
                        "bucket_name": {
                            "Ref": "LogsBucketName"
                        }
                    }
                },
                "Timeout": 900,
                "Description": "Only EC2InstanceLambda",
                "Handler": "ec2_instance_report.lambda_handler",
                "FunctionName": "SSM-EC2InstanceReport",
                "Runtime": "python3.7",
                "MemorySize": 128
            }
        }
    },
    "Outputs": {
        "EC2MasterLambda": {
            "Description": "Lambda created ",
            "Value": {
                "Ref": "EC2MasterLambda"
            }
        },
        "EC2SlaveLambda": {
            "Description": "Lambda created ",
            "Value": {
                "Ref": "EC2SlaveLambda"
            }
        },
        "CSVMergeLambda": {
            "Description": "Lambda created ",
            "Value": {
                "Ref": "CSVMergeLambda"
            }
        },
        "PatchBaselineLambda": {
            "Description": "Lambda created ",
            "Value": {
                "Ref": "PatchBaselineLambda"
            }
        },
        "EC2InstanceLambda": {
            "Description": "Lambda created ",
            "Value": {
                "Ref": "EC2InstanceLambda"
            }
        }
    }
}